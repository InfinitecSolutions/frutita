# Nombre del flujo de trabajo que aparecerá en GitHub
name: Actualizar Precios en Gist

# Evento que activa este flujo: un 'dispatch' llamado 'update_prices'
on:
  repository_dispatch:
    types: [update_prices]

# Tareas a realizar
jobs:
  # Tarea para actualizar el Gist
  update-gist:
    # Se ejecuta en la última versión de Ubuntu
    runs-on: ubuntu-latest
    
    # Permisos que necesita el flujo. Principio de menor privilegio.
    permissions:
      contents: read # Solo necesita leer el contenido del repo
      gist: write    # Necesita permiso para escribir en el Gist

    # Pasos de la tarea
    steps:
      # Paso 1: Actualizar el Gist con los nuevos precios
      - name: Actualizar Gist con nuevos precios
        # Usa la acción oficial de GitHub para ejecutar scripts
        uses: actions/github-script@v6
        with:
          # Usa el token que guardamos de forma segura en los Secrets del repo
          github-token: ${{ secrets.GIST_TOKEN }}
          # El script que se ejecutará
          script: |
            // ID del Gist que queremos modificar
            const gistId = '7796cbf91e8445723bed7b2264747f4a';
            
            // Obtenemos los nuevos precios del 'payload' que envió admin.html
            const newPrices = context.payload.client_payload.prices;
            
            // Obtenemos la información actual del Gist para saber el nombre del archivo
            const { data: gist } = await github.rest.gists.get({
              gist_id: gistId,
            });
            
            const fileName = Object.keys(gist.files)[0];
            
            // Actualizamos el contenido del archivo en el Gist
            await github.rest.gists.update({
              gist_id: gistId,
              files: {
                [fileName]: {
                  content: JSON.stringify(newPrices, null, 2) // Formateamos el JSON para que sea legible
                }
              }
            });
            
            console.log('Gist actualizado con éxito.');
